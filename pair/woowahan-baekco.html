<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우아한 코테 - 백준 문제집 랜덤 추천</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        
        /* Custom Dual Range Slider */
        .slider-track {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            position: relative;
        }
        .slider-range {
            background: #3b82f6;
            height: 100%;
            position: absolute;
            border-radius: 4px;
        }
        .slider-thumb {
            width: 20px;
            height: 20px;
            background: #fff;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Problem Content Styling */
        .problem-content h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #111827; }
        .problem-content p { margin-bottom: 1rem; line-height: 1.6; }
        .problem-content .sampledata { background-color: #f8fafc; padding: 1rem; border-radius: 0.375rem; font-family: monospace; white-space: pre-wrap; border: 1px solid #e2e8f0; margin-bottom: 1rem; }
        .problem-content img { max-width: 100%; height: auto; display: block; margin: 1rem auto; }
        .problem-content ul, .problem-content ol { padding-left: 1.5rem; margin-bottom: 1rem; }
        .problem-content li { margin-bottom: 0.25rem; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI 피드백 가독성 최적화 */
        .markdown-body { font-size: 1.05rem; line-height: 1.8; letter-spacing: -0.02em; color: #1f2937; word-break: keep-all; }
        .markdown-body p { margin-bottom: 1.25rem; }
        .markdown-body pre { background: #1e293b; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1.25rem 0; font-size: 0.95rem; line-height: 1.5; }
        .markdown-body code { font-family: monospace; background: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 0.25rem; color: #ef4444; font-size: 0.9em; }
        .markdown-body pre code { background: none; color: inherit; padding: 0; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.25rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1.25rem; }
        .markdown-body li { margin-bottom: 0.5rem; }
        .markdown-body h3 { font-size: 1.25rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1rem; color: #1e40af;}
        .markdown-body h4 { font-size: 1.1rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #374151;}
        .markdown-body strong { color: #111827; font-weight: 700; }
        .markdown-body blockquote { border-left: 4px solid #cbd5e1; padding-left: 1rem; color: #64748b; margin: 1.25rem 0; }
    </style>
</head>
<body class="min-h-screen">
    <!-- 커스텀 모달 UI (alert 대체) -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center transition-opacity">
        <div class="bg-white rounded-xl shadow-lg max-w-sm w-full p-6 mx-4 transform transition-all">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-amber-100 mb-4 mx-auto">
                <i class="fas fa-exclamation-triangle text-amber-600 text-xl"></i>
            </div>
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 text-center mb-2">알림</h3>
            <p id="modal-message" class="text-sm text-gray-500 text-center mb-6 whitespace-pre-wrap">메시지 내용</p>
            <button id="btn-modal-close" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">확인</button>
        </div>
    </div>

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-center items-center">
            <h1 class="text-xl font-bold text-blue-600 flex items-center tracking-tight">
                <i class="fas fa-laptop-code mr-2 text-blue-500"></i>
                우아한 코테
            </h1>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- 왼쪽 설정 패널 -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold mb-4 border-b pb-2"><i class="fas fa-cogs mr-2 text-gray-500"></i>문제 추천 설정</h2>
                
                <!-- 문제집 링크 입력 -->
                <div class="mb-5">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">백준 문제집 링크</label>
                    <input type="text" id="workbook-url" placeholder="https://www.acmicpc.net/workbook/view/..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" value="https://www.acmicpc.net/workbook/view/1">
                    <button id="btn-crawl" class="mt-2 w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-2 px-4 rounded-lg transition text-sm flex justify-center items-center">
                        <span id="btn-crawl-text">문제집 크롤링 등록</span>
                        <div id="btn-crawl-loader" class="loader ml-2 hidden" style="width: 16px; height: 16px; border-width: 2px;"></div>
                    </button>
                    <p id="crawl-status" class="text-xs text-gray-500 mt-2"></p>
                </div>

                <!-- 난이도 슬라이더 -->
                <div class="mb-5 opacity-50 pointer-events-none transition-opacity" id="filter-section">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">난이도 범위 설정</label>
                    <div class="flex justify-between text-xs text-gray-500 mb-2 font-medium">
                        <span id="tier-min-label" class="text-amber-700">브론즈 5</span>
                        <span id="tier-max-label" class="text-cyan-500">다이아 1</span>
                    </div>
                    
                    <div class="relative w-full h-8 mb-4">
                        <div class="slider-track absolute top-3 w-full">
                            <div class="slider-range" id="slider-range"></div>
                        </div>
                        <div class="slider-thumb" id="thumb-min" style="left: 0%;"></div>
                        <div class="slider-thumb" id="thumb-max" style="left: 100%;"></div>
                    </div>
                    
                    <!-- 알고리즘 유형 선택 -->
                    <label class="block text-sm font-semibold text-gray-700 mb-2 mt-6">알고리즘 유형</label>
                    <select id="algo-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm bg-white">
                        <option value="random">무작위 (전체)</option>
                    </select>

                    <!-- 정보 숨김 토글 (추천 받기 전 설정) -->
                    <div class="mt-6 border-t pt-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">문제 정보 표시 설정</label>
                        <div class="flex flex-col gap-3">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggle-tier" class="sr-only peer" checked>
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ms-3 text-sm font-medium text-gray-700">난이도 보기</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggle-algo" class="sr-only peer" checked>
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ms-3 text-sm font-medium text-gray-700">알고리즘 유형 보기</span>
                            </label>
                        </div>
                    </div>

                    <button id="btn-recommend" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition flex justify-center items-center">
                        <i class="fas fa-random mr-2"></i> 오늘 1문제 랜덤 추천받기
                    </button>
                </div>
            </div>
        </div>

        <!-- 오른쪽 메인 콘텐츠 패널 -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- 추천된 문제 뷰어 -->
            <div id="problem-viewer" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hidden">
                
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800" id="view-title">문제 제목 로딩중...</h2>
                        <a id="view-link" href="#" target="_blank" class="text-sm text-blue-500 hover:underline mt-1 inline-block"><i class="fas fa-external-link-alt mr-1"></i>백준에서 보기 (<span id="view-id"></span>)</a>
                    </div>
                </div>

                <!-- 뱃지 정보 -->
                <div class="flex flex-wrap gap-2 mb-6" id="view-badges">
                    <span id="badge-tier" class="px-3 py-1 bg-gradient-to-r from-amber-200 to-amber-300 text-amber-900 rounded-full text-sm font-bold shadow-sm">브론즈 5</span>
                    <span id="badge-algo" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm font-medium">수학</span>
                </div>

                <!-- 문제 본문 (크롤링 데이터 주입) -->
                <div id="problem-body" class="problem-content text-gray-800">
                    <div class="text-center py-10 text-gray-400">
                        <div class="loader mb-4"></div>
                        <p>문제 본문을 가져오는 중입니다...</p>
                    </div>
                </div>
                
                <!-- 연관 문제 목록 -->
                <div class="mt-10 pt-6 border-t border-gray-100">
                    <h3 class="text-sm font-bold text-gray-500 mb-3"><i class="fas fa-link mr-2"></i>이 문제집의 연관 문제 (크롤링 결과)</h3>
                    <div id="related-problems" class="flex flex-wrap gap-2">
                        <!-- 동적 생성 -->
                    </div>
                </div>
            </div>

            <!-- 텅 빈 상태 -->
            <div id="empty-state" class="bg-white p-12 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center h-[500px]">
                <div class="w-24 h-24 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center text-4xl mb-4">
                    <i class="fas fa-book-open"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">문제집을 등록하고 문제를 추천받아보세요</h3>
                <p class="text-gray-500 text-sm max-w-md">백준 문제집 URL을 입력하면 실시간으로 데이터를 크롤링하여 조건에 맞는 오늘의 추천 문제를 제공합니다.</p>
            </div>

            <!-- AI 피드백 섹션 -->
            <div id="ai-feedback-section" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-robot text-blue-600 mr-2 text-xl"></i>
                    AI 코드 피드백
                </h2>
                <p class="text-sm text-gray-600 mb-4">작성하신 코드를 붙여넣으시면 <b>적절한 자료구조, 불필요한 변수, 효율성, 시간 복잡도, 그리고 이해를 돕는 시각적 인포그래픽(다이어그램)</b>에 대해 분석해 드립니다.</p>
                
                <textarea id="user-code" rows="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm bg-gray-50" placeholder="여기에 작성한 코드를 붙여넣어주세요 (C++, Python, Java, JS 등)"></textarea>
                
                <button id="btn-feedback" class="mt-4 w-full bg-slate-800 hover:bg-slate-900 text-white font-medium py-3 px-4 rounded-lg shadow transition flex justify-center items-center">
                    <span id="btn-feedback-text">AI 분석 요청하기</span>
                    <div id="btn-feedback-loader" class="loader ml-2 hidden" style="width: 16px; height: 16px; border-width: 2px;"></div>
                </button>

                <div id="feedback-result" class="mt-6 hidden">
                    <h3 class="text-md font-bold text-gray-800 border-b pb-2 mb-4">분석 결과</h3>
                    <div id="feedback-content" class="markdown-body text-sm text-gray-700 bg-blue-50/50 p-5 rounded-lg border border-blue-100">
                        <!-- 마크다운 결과 렌더링 영역 -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 상수 및 상태 관리 ---
        const SOLVED_AC_API = "https://solved.ac/api/v3/problem/lookup?problemIds=";
        const apiKey = ""; // Gemini API Key
        
        // 티어 매핑 (1: 브론즈5 ~ 25: 다이아1)
        const TIER_NAMES = [
            "Unrated", 
            "브론즈 5", "브론즈 4", "브론즈 3", "브론즈 2", "브론즈 1",
            "실버 5", "실버 4", "실버 3", "실버 2", "실버 1",
            "골드 5", "골드 4", "골드 3", "골드 2", "골드 1",
            "플래티넘 5", "플래티넘 4", "플래티넘 3", "플래티넘 2", "플래티넘 1",
            "다이아 5", "다이아 4", "다이아 3", "다이아 2", "다이아 1"
        ];
        
        // Solved.ac 공식 색상 매핑
        const TIER_COLORS = {
            "브론즈": { bg: "#ad5600", text: "#ffffff" },
            "실버": { bg: "#435f7a", text: "#ffffff" },
            "골드": { bg: "#ec9a00", text: "#ffffff" },
            "플래티넘": { bg: "#27e2a4", text: "#0f172a" },
            "다이아": { bg: "#00b4fc", text: "#0f172a" },
            "Unrated": { bg: "#2d2d2d", text: "#ffffff" }
        };

        let state = {
            workbookProblems: [], // 문제집에서 크롤링한 ID 목록
            problemDetails: {},   // solved.ac에서 가져온 문제 상세 정보 (티어, 태그)
            availableTags: new Set(),
            minTier: 1,
            maxTier: 25,
            currentProblemContext: null // AI 피드백을 위한 현재 추천 문제 컨텍스트
        };

        // --- DOM 요소 ---
        const els = {
            urlInput: document.getElementById('workbook-url'),
            btnCrawl: document.getElementById('btn-crawl'),
            crawlText: document.getElementById('btn-crawl-text'),
            crawlLoader: document.getElementById('btn-crawl-loader'),
            crawlStatus: document.getElementById('crawl-status'),
            filterSection: document.getElementById('filter-section'),
            algoSelect: document.getElementById('algo-select'),
            btnRecommend: document.getElementById('btn-recommend'),
            
            // Slider
            thumbMin: document.getElementById('thumb-min'),
            thumbMax: document.getElementById('thumb-max'),
            sliderRange: document.getElementById('slider-range'),
            tierMinLabel: document.getElementById('tier-min-label'),
            tierMaxLabel: document.getElementById('tier-max-label'),

            // Viewer
            emptyState: document.getElementById('empty-state'),
            problemViewer: document.getElementById('problem-viewer'),
            viewTitle: document.getElementById('view-title'),
            viewId: document.getElementById('view-id'),
            viewLink: document.getElementById('view-link'),
            viewBadges: document.getElementById('view-badges'),
            badgeTier: document.getElementById('badge-tier'),
            badgeAlgo: document.getElementById('badge-algo'),
            problemBody: document.getElementById('problem-body'),
            relatedProblems: document.getElementById('related-problems'),
            
            // Toggles
            toggleTier: document.getElementById('toggle-tier'),
            toggleAlgo: document.getElementById('toggle-algo'),

            // Feedback
            feedbackSection: document.getElementById('ai-feedback-section'),
            userCode: document.getElementById('user-code'),
            btnFeedback: document.getElementById('btn-feedback'),
            btnFeedbackText: document.getElementById('btn-feedback-text'),
            btnFeedbackLoader: document.getElementById('btn-feedback-loader'),
            feedbackResult: document.getElementById('feedback-result'),
            feedbackContent: document.getElementById('feedback-content'),
            
            // Modal
            modal: document.getElementById('custom-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            btnModalClose: document.getElementById('btn-modal-close'),
        };

        // --- 커스텀 모달 (alert 대체) ---
        function showAlert(title, message) {
            els.modalTitle.textContent = title;
            els.modalMessage.textContent = message;
            els.modal.classList.remove('hidden');
        }

        els.btnModalClose.addEventListener('click', () => {
            els.modal.classList.add('hidden');
        });

        // --- 슬라이더 로직 ---
        let isDraggingMin = false;
        let isDraggingMax = false;

        function updateSlider() {
            const minPercent = ((state.minTier - 1) / 24) * 100;
            const maxPercent = ((state.maxTier - 1) / 24) * 100;
            
            els.thumbMin.style.left = `${minPercent}%`;
            els.thumbMax.style.left = `${maxPercent}%`;
            els.sliderRange.style.left = `${minPercent}%`;
            els.sliderRange.style.width = `${maxPercent - minPercent}%`;
            
            els.tierMinLabel.textContent = TIER_NAMES[state.minTier];
            els.tierMaxLabel.textContent = TIER_NAMES[state.maxTier];
        }

        function handleThumbDrag(e, isMin) {
            const rect = els.thumbMin.parentElement.getBoundingClientRect();
            let clientX = e.clientX;
            if (e.touches) clientX = e.touches[0].clientX;
            
            let percent = (clientX - rect.left) / rect.width;
            percent = Math.max(0, Math.min(1, percent));
            
            let value = Math.round(percent * 24) + 1;
            
            if (isMin) {
                state.minTier = Math.min(value, state.maxTier);
            } else {
                state.maxTier = Math.max(value, state.minTier);
            }
            updateSlider();
        }

        els.thumbMin.addEventListener('mousedown', () => isDraggingMin = true);
        els.thumbMax.addEventListener('mousedown', () => isDraggingMax = true);
        document.addEventListener('mouseup', () => { isDraggingMin = false; isDraggingMax = false; });
        document.addEventListener('mousemove', (e) => {
            if (isDraggingMin) handleThumbDrag(e, true);
            if (isDraggingMax) handleThumbDrag(e, false);
        });
        
        // Touch support
        els.thumbMin.addEventListener('touchstart', () => isDraggingMin = true, {passive: true});
        els.thumbMax.addEventListener('touchstart', () => isDraggingMax = true, {passive: true});
        document.addEventListener('touchend', () => { isDraggingMin = false; isDraggingMax = false; });
        document.addEventListener('touchmove', (e) => {
            if (isDraggingMin) handleThumbDrag(e, true);
            if (isDraggingMax) handleThumbDrag(e, false);
        }, {passive: true});

        // --- 크롤링 유틸리티 ---
        async function fetchHtmlText(targetUrl) {
            const PROXIES = [
                "https://api.allorigins.win/get?url=",
                "https://api.codetabs.com/v1/proxy?quest=",
                "https://corsproxy.io/?"
            ];
            
            let lastError = null;
            
            for (const proxy of PROXIES) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(targetUrl);
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`Status ${response.status}`);
                    
                    let htmlText = "";
                    if (proxy.includes("allorigins.win/get")) {
                        const data = await response.json();
                        htmlText = data.contents;
                    } else {
                        htmlText = await response.text();
                    }
                    
                    if (htmlText && htmlText.includes("problem")) {
                        return htmlText;
                    } else {
                        throw new Error("Invalid content or Blocked by Cloudflare");
                    }
                } catch (error) {
                    lastError = error;
                    console.warn(`Proxy ${proxy} failed:`, error);
                }
            }
            throw new Error(`모든 프록시 요청 실패. (보안 정책에 의해 차단되었을 수 있습니다.) 마지막 에러: ${lastError?.message}`);
        }

        // Solved.ac API 통신을 위한 JSON 전용 프록시 Fetch 함수 추가
        async function fetchJsonWithProxy(targetUrl) {
            const PROXIES = [
                "https://api.allorigins.win/get?url=",
                "https://api.codetabs.com/v1/proxy?quest=",
                "https://corsproxy.io/?"
            ];
            
            let lastError = null;
            
            for (const proxy of PROXIES) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(targetUrl);
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`Status ${response.status}`);
                    
                    if (proxy.includes("allorigins.win/get")) {
                        const data = await response.json();
                        // allorigins의 경우 JSON 응답 결과도 contents 안에 문자열로 래핑되어 반환됨
                        return JSON.parse(data.contents);
                    } else {
                        return await response.json();
                    }
                } catch (error) {
                    lastError = error;
                    console.warn(`Proxy ${proxy} failed for JSON:`, error);
                }
            }
            throw new Error(`모든 JSON 프록시 요청 실패. 마지막 에러: ${lastError?.message}`);
        }

        async function fetchSolvedAcData(problemIds) {
            // solved.ac API는 한 번에 최대 100개까지 조회 가능
            const results = {};
            const chunkSize = 100;
            for (let i = 0; i < problemIds.length; i += chunkSize) {
                const chunk = problemIds.slice(i, i + chunkSize);
                try {
                    // 직접 fetch 대신 fetchJsonWithProxy 우회 함수 사용
                    const data = await fetchJsonWithProxy(SOLVED_AC_API + chunk.join(','));
                    data.forEach(p => { results[p.problemId] = p; });
                } catch (error) {
                    console.error("Solved.ac API Fetch Error:", error);
                    throw new Error("문제 난이도 정보를 가져오는데 실패했습니다.");
                }
            }
            return results;
        }

        function getTierColorClass(tierName) {
            const prefix = tierName.split(' ')[0];
            return TIER_COLORS[prefix] || TIER_COLORS["Unrated"];
        }

        // --- 핵심 기능 ---

        // 1. 문제집 크롤링
        els.btnCrawl.addEventListener('click', async () => {
            const url = els.urlInput.value.trim();
            if (!url) { showAlert('입력 오류', '문제집 URL을 입력해주세요.'); return; }

            els.crawlLoader.classList.remove('hidden');
            els.crawlText.textContent = '크롤링 중...';
            els.btnCrawl.disabled = true;
            els.crawlStatus.textContent = '';
            els.crawlStatus.className = "text-xs mt-2 text-gray-500";

            try {
                // 백준 문제집 페이지 크롤링
                const htmlText = await fetchHtmlText(url);
                
                // 문제 번호 추출 (정규표현식을 사용하여 문자열에서 직접 추출하여 안정성 확보)
                const regex = /\/problem\/([0-9]+)/g;
                let match;
                const idsSet = new Set();
                while ((match = regex.exec(htmlText)) !== null) {
                    idsSet.add(match[1]);
                }
                const ids = [...idsSet];

                if (ids.length === 0) {
                    throw new Error('문제집에서 문제를 찾을 수 없거나 올바르지 않은 백준 문제집 링크입니다. (또는 봇 방지로 인해 크롤링이 차단되었습니다.)');
                }

                els.crawlStatus.textContent = `문제집에서 ${ids.length}개의 문제를 성공적으로 찾았습니다. 난이도 정보 수집 중...`;

                // 추출한 문제들의 세부 정보(티어, 태그)를 solved.ac 에서 조회
                const details = await fetchSolvedAcData(ids);
                state.workbookProblems = ids;
                state.problemDetails = details;

                // 알고리즘 종류 추출 및 셀렉트 박스 세팅
                state.availableTags.clear();
                Object.values(details).forEach(p => {
                    p.tags.forEach(t => {
                        const tagName = t.displayNames.find(d => d.language === 'ko')?.name || t.key;
                        state.availableTags.add(tagName);
                    });
                });

                els.algoSelect.innerHTML = '<option value="random">무작위 (전체)</option>';
                Array.from(state.availableTags).sort().forEach(tag => {
                    els.algoSelect.innerHTML += `<option value="${tag}">${tag}</option>`;
                });

                els.filterSection.classList.remove('opacity-50', 'pointer-events-none');
                els.crawlStatus.textContent = `크롤링 완료! 총 ${ids.length}문제 정보가 등록되었습니다.`;
                els.crawlStatus.className = "text-xs mt-2 text-green-600 font-semibold";

            } catch (error) {
                console.error(error);
                els.crawlStatus.textContent = `크롤링 실패: ${error.message}`;
                els.crawlStatus.className = "text-xs mt-2 text-red-500 font-semibold";
            } finally {
                els.crawlLoader.classList.add('hidden');
                els.crawlText.textContent = '문제집 크롤링 재등록';
                els.btnCrawl.disabled = false;
            }
        });

        // 2. 조건에 맞는 문제 추천 및 상세 정보 크롤링
        els.btnRecommend.addEventListener('click', async () => {
            const selectedAlgo = els.algoSelect.value;
            
            // 필터링
            const filtered = state.workbookProblems.filter(id => {
                const detail = state.problemDetails[id];
                if (!detail) return false;

                // 난이도 필터
                if (detail.level < state.minTier || detail.level > state.maxTier) return false;

                // 알고리즘 필터
                if (selectedAlgo !== 'random') {
                    const hasTag = detail.tags.some(t => {
                        const tName = t.displayNames.find(d => d.language === 'ko')?.name || t.key;
                        return tName === selectedAlgo;
                    });
                    if (!hasTag) return false;
                }
                
                return true;
            });

            if (filtered.length === 0) {
                showAlert('추천 실패', '설정한 조건(난이도 또는 알고리즘)에 맞는 문제가 현재 문제집에 없습니다.\n조건을 변경해주세요.');
                return;
            }

            // 무작위 1개 선택
            const recommendedId = filtered[Math.floor(Math.random() * filtered.length)];
            const probDetail = state.problemDetails[recommendedId];
            const tierName = TIER_NAMES[probDetail.level] || "Unrated";

            // UI 상태 변경
            els.emptyState.classList.add('hidden');
            els.problemViewer.classList.remove('hidden');
            els.feedbackSection.classList.remove('hidden');
            els.feedbackResult.classList.add('hidden');
            els.userCode.value = '';
            
            // 기본 메타데이터 세팅
            els.viewTitle.textContent = `${probDetail.titleKo} 로딩 중...`;
            els.viewId.textContent = recommendedId;
            els.viewLink.href = `https://www.acmicpc.net/problem/${recommendedId}`;
            
            const tierStyle = getTierColorClass(tierName);
            // solved.ac 공식 티어 SVG 아이콘 삽입 및 색상 적용
            els.badgeTier.innerHTML = `<img src="https://static.solved.ac/tier_small/${probDetail.level}.svg" class="w-4 h-4 inline-block mr-1 align-text-bottom" alt="tier" onerror="this.style.display='none'"> ${tierName}`;
            els.badgeTier.className = `px-3 py-1.5 rounded-md text-sm font-bold shadow-sm transition-opacity duration-300 inline-flex items-center`;
            els.badgeTier.style.backgroundColor = tierStyle.bg;
            els.badgeTier.style.color = tierStyle.text;
            
            const algoText = probDetail.tags.map(t => t.displayNames.find(d => d.language === 'ko')?.name || t.key).join(', ') || '태그 없음';
            els.badgeAlgo.textContent = algoText;
            els.badgeAlgo.className = `px-3 py-1.5 bg-gray-200 text-gray-700 rounded-md text-sm font-medium transition-opacity duration-300 inline-flex items-center`;

            applyToggleStates();

            els.problemBody.innerHTML = `
                <div class="text-center py-10 text-gray-400">
                    <div class="loader mb-4"></div>
                    <p>백준에서 문제 본문을 크롤링하는 중입니다...</p>
                </div>
            `;

            // 연관 문제 세팅 (현재 추천 문제 제외한 문제집의 모든 문제)
            els.relatedProblems.innerHTML = '';
            state.workbookProblems.forEach(id => {
                if (id === recommendedId) return;
                const a = document.createElement('a');
                a.href = `https://www.acmicpc.net/problem/${id}`;
                a.target = "_blank";
                a.className = "px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded text-xs transition";
                a.textContent = id;
                els.relatedProblems.appendChild(a);
            });

            try {
                // 문제 본문 실시간 크롤링 (본문, 입출력 등)
                const htmlText = await fetchHtmlText(`https://www.acmicpc.net/problem/${recommendedId}`);
                const doc = new DOMParser().parseFromString(htmlText, "text/html");
                
                const title = doc.querySelector('#problem_title')?.textContent || probDetail.titleKo;
                els.viewTitle.textContent = title;

                const descHtml = doc.querySelector('#problem_description')?.innerHTML || '<p>본문을 불러올 수 없습니다.</p>';
                const inputHtml = doc.querySelector('#problem_input')?.innerHTML || '';
                const outputHtml = doc.querySelector('#problem_output')?.innerHTML || '';
                
                let sampleHtml = '';
                for(let i=1; i<=10; i++) {
                    const sampleIn = doc.querySelector(`#sample-input-${i}`);
                    const sampleOut = doc.querySelector(`#sample-output-${i}`);
                    if (!sampleIn) break;
                    
                    sampleHtml += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h3 class="font-bold text-gray-700 mb-2">예제 입력 ${i}</h3>
                                <div class="sampledata">${sampleIn.innerHTML}</div>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-700 mb-2">예제 출력 ${i}</h3>
                                <div class="sampledata">${sampleOut.innerHTML}</div>
                            </div>
                        </div>
                    `;
                }

                els.problemBody.innerHTML = `
                    <div class="mb-8">
                        <h2 class="border-b-2 border-gray-100 pb-2">문제 설명</h2>
                        <div class="mt-4">${descHtml}</div>
                    </div>
                    <div class="mb-8">
                        <h2 class="border-b-2 border-gray-100 pb-2">입력</h2>
                        <div class="mt-4">${inputHtml}</div>
                    </div>
                    <div class="mb-8">
                        <h2 class="border-b-2 border-gray-100 pb-2">출력</h2>
                        <div class="mt-4">${outputHtml}</div>
                    </div>
                    <div>
                        <h2 class="border-b-2 border-gray-100 pb-2 mb-4">예제 입출력</h2>
                        ${sampleHtml}
                    </div>
                `;

                // AI 컨텍스트 저장용 텍스트 추출 (순수 텍스트)
                state.currentProblemContext = {
                    title: title,
                    description: doc.querySelector('#problem_description')?.textContent.trim().substring(0, 1000) // API 리밋 방지용 일부 자르기
                };

            } catch (error) {
                console.error("문제 본문 크롤링 에러:", error);
                els.problemBody.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded">문제 본문을 가져오는데 실패했습니다. (CORS 에러 또는 변경된 구조)</div>`;
            }
        });

        // 3. 숨김 처리 기능 (정보 제공 유무)
        function applyToggleStates() {
            els.badgeTier.style.opacity = els.toggleTier.checked ? '1' : '0';
            els.badgeAlgo.style.opacity = els.toggleAlgo.checked ? '1' : '0';
        }
        els.toggleTier.addEventListener('change', applyToggleStates);
        els.toggleAlgo.addEventListener('change', applyToggleStates);


        // 4. AI 기반 피드백 기능 (Gemini API)
        async function fetchGeminiAPI(prompt, retries = 5, delay = 1000) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "당신은 알고리즘 코딩 테스트를 지도하는 전문 멘토입니다. 반드시 한국어로 답변하며, 친절하고 명확하게 구조화된 마크다운 형식으로 피드백을 제공하세요." }] }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
                    }
                    
                    const result = await response.json();
                    if (result.error) throw new Error(result.error.message);
                    
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("API 응답에서 텍스트를 찾을 수 없습니다.");
                    
                    return text;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        els.btnFeedback.addEventListener('click', async () => {
            const code = els.userCode.value.trim();
            if (!code) {
                showAlert("입력 오류", "분석할 코드를 입력해주세요.");
                return;
            }
            if (!state.currentProblemContext) {
                showAlert("상태 오류", "추천된 문제 정보가 로드되지 않았습니다. 먼저 문제를 추천받아주세요.");
                return;
            }

            els.btnFeedbackLoader.classList.remove('hidden');
            els.btnFeedbackText.textContent = "AI가 코드 분석 중입니다...";
            els.btnFeedback.disabled = true;
            els.feedbackResult.classList.add('hidden');

            const prompt = `
사용자가 백준 알고리즘 문제 "${state.currentProblemContext.title}"에 대해 코드를 작성했습니다.
문제 설명 일부: ${state.currentProblemContext.description}

사용자 코드:
\`\`\`
${code}
\`\`\`

아래 5가지 항목에 대해 명확하고 상세하게 한국어로 피드백을 작성해주세요.
1. 적절한 자료구조를 사용하였는지에 대한 평가
2. 불필요하게 사용된 변수나 로직이 있는지 확인
3. 더 효율적이거나 깔끔한 알고리즘/방법 제시
4. 작성된 코드의 알고리즘 시간 복잡도(Big-O) 분석
5. (중요) 해당 알고리즘의 동작 방식을 시각적으로 쉽게 이해할 수 있는 인포그래픽(텍스트 다이어그램)을 제공해주세요.
- 외부 라이브러리(Mermaid 등)는 절대 사용하지 마세요. (문법 에러 발생 위험)
- 반드시 유니코드 선 문자(├, └, │, ─, →, ↓ 등)와 ASCII Art를 활용하여 트리, 그래프, 배열 상태 변화 등을 텍스트로 직관적으로 그려주세요.
- 다이어그램은 반드시 \`\`\`diagram ... \`\`\` 코드 블록으로 감싸주세요.
`;

            try {
                const markdownResponse = await fetchGeminiAPI(prompt);
                
                if (!markdownResponse) {
                    throw new Error("AI 응답 데이터가 비어있습니다.");
                }

                els.feedbackContent.innerHTML = marked.parse(markdownResponse);
                
                // 텍스트 다이어그램(ASCII Art) 블록 디자인 강화
                const diagramBlocks = els.feedbackContent.querySelectorAll('code.language-diagram');
                diagramBlocks.forEach((block) => {
                    const pre = block.parentElement;
                    // 안정적이고 예쁜 칠판/터미널 스타일 적용
                    pre.className = "bg-slate-800 text-sky-300 p-6 rounded-xl border border-slate-700 shadow-inner my-6 overflow-x-auto font-mono text-sm leading-relaxed whitespace-pre";
                });
                
                els.feedbackResult.classList.remove('hidden');
            } catch (error) {
                console.error("AI API Error:", error);
                showAlert("API 오류", "AI 피드백을 받아오는데 실패했습니다. 잠시 후 다시 시도해주세요.");
            } finally {
                els.btnFeedbackLoader.classList.add('hidden');
                els.btnFeedbackText.textContent = "AI 분석 요청하기";
                els.btnFeedback.disabled = false;
            }
        });

        // 초기화
        updateSlider();
    </script>
</body>
</html>